define("tiny_ai/ui",["exports","core/modal_factory","core/modal_events","tiny_ai/modal","tiny_ai/options","core/ajax","core/templates","tiny_ai/textmark"],(function(_exports,_modal_factory,_modal_events,_modal,_options,_ajax,_templates,_textmark){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny AI UI.
   *
   * @module      tiny_ai/ui
   * @copyright   2023 Matt Porritt <matt.porritt@moodle.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.displayModal=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_modal=_interopRequireDefault(_modal),_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates);let responseObj=null;_exports.displayModal=async editor=>{const modalObject=await _modal_factory.default.create({type:_modal.default.TYPE,templateContext:getTemplateContext(editor),large:!0}),modalroot=await modalObject.getRoot(),root=modalroot[0];modalObject.show(),modalroot.on(_modal_events.default.hidden,(()=>{modalObject.destroy()})),root.addEventListener("click",(e=>{const submitBtn=e.target.closest('[data-action="generate"]'),insertBtn=e.target.closest('[data-action="inserter"]'),cancelBtn=e.target.closest('[data-action="cancel"]');submitBtn?(e.preventDefault(),handleSubmit(editor,root,submitBtn)):insertBtn?(e.preventDefault(),handleInsert(editor,root),modalObject.destroy()):cancelBtn&&modalObject.destroy()}))};const getTemplateContext=editor=>({elementid:editor.id}),handleSubmit=async(editor,root,submitBtn)=>{displayLoading(editor.id,root,submitBtn);const request={methodname:"tiny_ai_generate_content",args:{contextid:(0,_options.getContextId)(editor),prompttext:root.querySelector("#"+editor.id+"_tiny_ai_prompttext").value}};try{responseObj=await _ajax.default.call([request])[0];const generatedResponseEl=root.querySelector("#"+editor.id+"_tiny_ai_responsetext"),insertBtn=root.querySelector('[data-action="inserter"]');generatedResponseEl.value=responseObj.generatedcontent,generatedResponseEl.disabled=!1,hideLoading(editor.id,root,submitBtn),insertBtn.classList.remove("hidden")}catch(error){window.console.log(error)}},displayLoading=(editorId,root,submitBtn)=>{const loadingSpinnerDiv=root.querySelector("#"+editorId+"_tiny_ai_spinner"),overlayDiv=root.querySelector("#"+editorId+"_tiny_ai_overlay"),blurDiv=root.querySelector("#"+editorId+"_tiny_ai_blur");loadingSpinnerDiv.classList.remove("hidden"),overlayDiv.classList.remove("hidden"),blurDiv.classList.add("tiny-ai-blur"),submitBtn.innerHTML="Generating...",submitBtn.disabled=!0},hideLoading=(editorId,root,submitBtn)=>{const loadingSpinnerDiv=root.querySelector("#"+editorId+"_tiny_ai_spinner"),overlayDiv=root.querySelector("#"+editorId+"_tiny_ai_overlay"),blurDiv=root.querySelector("#"+editorId+"_tiny_ai_blur");loadingSpinnerDiv.classList.add("hidden"),overlayDiv.classList.add("hidden"),blurDiv.classList.remove("tiny-ai-blur"),submitBtn.innerHTML="Regenerate",submitBtn.disabled=!1},handleInsert=async(editor,root)=>{const generatedResponseEl=root.querySelector("#"+editor.id+"_tiny_ai_responsetext"),wrappedEditedResponse=await(0,_textmark.wrapEditedSections)(responseObj.generatedcontent,generatedResponseEl.value);responseObj.editedtext=(text=>{const textWithBreaks=text.replace(/\n{2,}|\r\n/g,"</p><p>").replace(/\n/g,"<br>");return"<p>".concat(textWithBreaks,"</p>")})(wrappedEditedResponse),window.console.log(responseObj);const formattedResponse=await _templates.default.render("tiny_ai/insert",responseObj);editor.insertContent(formattedResponse),editor.execCommand("mceRepaint"),editor.windowManager.close()}}));

//# sourceMappingURL=ui.min.js.map